- name: Create a security group
  community.aws.ec2_group:
    name: "{{ security_group_name }}"
    description: "Security group for my EC2 instance"
    vpc_id: "{{ vpc_id }}"
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: 0.0.0.0/0
  register: security_group

- name: Launch EC2 instance
  community.aws.ec2_instance:
    instance_type: "{{ instance_type }}"
    image_id: "{{ ami_id }}"
    region: "{{ region }}"
    key_name: "{{ key_name }}"
    count: "{{ instance_count }}"
    security_group_ids:
      - "{{ security_group.group_id }}"
    vpc_subnet_id: "{{ subnet_id }}"
    assign_public_ip: yes
    tags:
      Name: "{{ instance_name }}"
  register: ec2_instance



